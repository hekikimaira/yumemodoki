<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Image Text Overlay Tool</title>

<style>
  body{
    margin:0;
    background:#111;
    color:#eee;
    font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    padding:12px;
  }

  .stage{
    position:relative;
    width:832px;
    height:1216px;
  }

  canvas{
    display:block;
    width:832px;
    height:1216px;
    background:#222;
    border-radius:10px;
  }

  /* 入力専用レイヤー（文字は表示しない） */
  textarea{
    position:absolute;
    top:36px;
    left:24px;
    width:784px;
    height:1144px;

    background:transparent;

    color:transparent;        /* ← 文字を消す */
    caret-color:#fff;         /* ← カーソルだけ表示 */
    text-shadow:none;

    border:none;
    padding:28px;

    font-size:30px;
    line-height:1.45;
    font-family:inherit;

    resize:none;
    outline:none;
    overflow:auto;
  }

  .controls{
    display:flex;
    gap:12px;
  }

  button{
    padding:10px 16px;
    border-radius:10px;
    border:1px solid #333;
    background:#222;
    color:#eee;
    font-weight:600;
    cursor:pointer;
  }
</style>
</head>

<body>

<div class="stage">
  <canvas id="cv" width="832" height="1216"></canvas>
  <textarea id="text" placeholder=""></textarea>
</div>

<div class="controls">
  <button id="btnImage">画像読み込み</button>
  <button id="btnSave">保存</button>
  <button id="btnHistory">履歴</button>
  <button id="btnClear">クリア</button>
</div>

<input id="file" type="file" accept="image/png,image/jpeg,image/webp" hidden>

<script>
/* ================= 定数 ================= */
const W = 832, H = 1216;
const WIN = { x:24, y:36, w:784, h:1144, r:18, pad:28 };
const FONT = 30, LINE = 44;

/* ================= 要素 ================= */
const cv = document.getElementById("cv");
const ctx = cv.getContext("2d");
const textEl = document.getElementById("text");
const fileInput = document.getElementById("file");

let bgImg = null;

/* ================= 描画 ================= */
function render(){
  ctx.clearRect(0,0,W,H);

  // 背景画像
  if(bgImg){
    const iw = bgImg.width, ih = bgImg.height;
    const s = Math.max(W/iw, H/ih);
    const w = iw*s, h = ih*s;
    ctx.drawImage(bgImg, (W-w)/2, (H-h)/2, w, h);
  }else{
    ctx.fillStyle="#222";
    ctx.fillRect(0,0,W,H);
  }

  // 黒ウィンドウ
  ctx.fillStyle="rgba(0,0,0,0.85)";
  roundRect(WIN.x, WIN.y, WIN.w, WIN.h, WIN.r);
  ctx.fill();

  // テキスト
  ctx.save();
  ctx.beginPath();
  ctx.rect(
    WIN.x + WIN.pad,
    WIN.y + WIN.pad,
    WIN.w - WIN.pad*2,
    WIN.h - WIN.pad*2
  );
  ctx.clip();

  ctx.font = `${FONT}px system-ui, sans-serif`;
  ctx.fillStyle="#fff";
  ctx.shadowColor="rgba(0,0,0,0.9)";
  ctx.shadowBlur=6;

  let x = WIN.x + WIN.pad;
  let y = WIN.y + WIN.pad + FONT;
  const maxY = WIN.y + WIN.h - WIN.pad;

  wrap(textEl.value).forEach(line=>{
    if(y > maxY) return;
    ctx.fillText(line, x, y);
    y += LINE;
  });

  ctx.restore();
}

function roundRect(x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

function wrap(text){
  const lines=[];
  const maxW = WIN.w - WIN.pad*2;
  ctx.font = `${FONT}px system-ui, sans-serif`;

  text.replace(/\r\n/g,"\n").split("\n").forEach(p=>{
    let cur="";
    for(const ch of p){
      const t = cur + ch;
      if(ctx.measureText(t).width <= maxW){
        cur = t;
      }else{
        lines.push(cur);
        cur = ch;
      }
    }
    lines.push(cur);
    lines.push("");
  });
  return lines;
}

/* ================= 操作 ================= */
textEl.addEventListener("input", render);

document.getElementById("btnImage").onclick = ()=>fileInput.click();
fileInput.onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  const img=new Image();
  img.onload=()=>{
    bgImg=img;
    render();
  };
  img.src=URL.createObjectURL(f);
};

document.getElementById("btnSave").onclick = ()=>{
  render();
  const a=document.createElement("a");
  a.download="export.png";
  a.href=cv.toDataURL("image/png");
  a.click();
};

document.getElementById("btnClear").onclick = ()=>{
  if(!confirm("クリアしますか？")) return;
  bgImg=null;
  textEl.value="";
  render();
};

render();
</script>

</body>
</html>
